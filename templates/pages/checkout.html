{{#partial "head"}}

{{{ checkout.checkout_head }}}
{{{ stylesheet '/assets/css/optimized-checkout.css' }}}
 
 
{{ getFontsCollection }} 
 
<script type="text/javascript">
    window.language = {{{langJson 'optimized_checkout'}}}; 
</script> 

{{{head.scripts}}} 


{{/partial}}

{{#partial "page"}}



 
<!-- UIkit CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.14/dist/css/uikit.min.css" />
<link rel="stylesheet" href="https://use.typekit.net/drc3iaj.css">

<!-- UIkit JS -->
<script src="https://cdn.jsdelivr.net/npm/uikit@3.15.14/dist/js/uikit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.15.14/dist/js/uikit-icons.min.js"></script>

<!-- CALL MOST RECENT JQUERY LIBRARY -->
<script src="https://code.jquery.com/jquery-3.6.2.min.js" integrity="sha256-2krYZKh//PcchRtd+H+VyyQoZ/e3EcrkxhM8ycwASPA=" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.min.css">


<script src="{{cdn 'assets/js/custom.js'}}"></script>
{{#if customer_group_name '!==' 'trade_blocked'}}
    <div id="optimised_main_chout">
        <header class="checkoutHeader optimizedCheckout-header">
            <div class="checkoutHeader-content">
                <h1 class="is-srOnly">{{lang 'checkout.title'}}</h1>
                <h2 class="checkoutHeader-heading">
                    <a class="checkoutHeader-link" href="{{urls.home}}">
                        {{#if checkout.header_image}}
                        <img alt="{{settings.store_logo.title}}" class="checkoutHeader-logo" id="logoImage" src="https://cdn11.bigcommerce.com/s-lh9wfk05w0/images/stencil/original/image-manager/d-logo.png"
                        alt="{{settings.store_logo.title}}"
                        title="{{settings.store_logo.title}}">
                        {{!--
                            <img alt="{{settings.store_logo.title}}" class="checkoutHeader-logo" id="logoImage" src="{{ checkout.header_image }}"/>
                            --}}
                            
                        {{ else }}
                            <span class="header-logo-text">{{settings.store_logo.title}}</span>
                        {{/if}}
                    </a>
                </h2>
            </div>
        </header>
        {{{ checkout.checkout_content }}}
    </div>
{{else}}
    <div class="container" style="height: 200px;display: flex;">
        <p style="margin: 50px auto;width: 80%;text-align: center;border: 1px solid;height: 50px;padding: 10px 5px;">You are currently blocked for shopping, Please contact to admin for more info</p>
    </div>
{{/if}}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhEVGvTFe26KQ1-eDZ9i10znl03qH1ZlI&libraries=places,geometry&v=weekly" defer ></script>

{{inject "checkoutID" cart_id}}
{{#if customer}}
    {{#unless customer_group_name '===' 'Trade'}}
    <script>
        var jsContext = JSON.parse({{jsContext}});

        let loyaltyInterval = setInterval(loyaltyCheck, 1000);
        function loyaltyCheck() {
            const elementParentType = document.querySelector('.layout-main')
            if (elementParentType) {
                const couponApply =  document.querySelector('#applyRedeemableButton')
                const couponRemove = document.querySelector('[data-test="cart-price-callback"]')
                if (couponApply) {
                    couponApply.addEventListener('click', () => {
                        setTimeout(function(){
                            window.location.reload()
                        },1500); //delay is in milliseconds 
                    })
                }
                if (couponRemove) {
                    couponRemove.addEventListener('click', () => {
                        window.location.reload()

                    })
                }
                const nextSibling = elementParentType.nextElementSibling;
                // Check if mobile or desktop view
                if (nextSibling && (nextSibling.classList.contains('layout-cart'))) {
                    // Desktop View
                    // Check if desktop loyalty already exists
                    const desktopLoyalty = document.querySelector('.cart-section.optimizedCheckout-orderSummary-cartSection.loyalty-points')
                    if (!desktopLoyalty ) {
                        // define location and start func
                        const element = document.querySelector('.cart.optimizedCheckout-orderSummary')
                        loyaltyInitialize(element);
                    }
                } else if (nextSibling && (nextSibling.classList.contains('cartDrawer'))) {
                    // Mobile View
                    // Check if mobile modal is open
                    const mobileModal = document.querySelector('.ReactModalPortal .modal')
                    if(mobileModal) {
                        // Check if mobile loyalty already exists
                        const mobileLoyalty = document.querySelector('.modal-body .cart-section.optimizedCheckout-orderSummary-cartSection.loyalty-points')
                        if (!mobileLoyalty) {
                            // define location and start func
                            const element = document.querySelector('.cart-modal-body.optimizedCheckout-orderSummary')
                            loyaltyInitialize(element);
                        }
                    }
                }
            }
        }

        function loyaltyInitialize(elementToAppend) {
        // Fetch loyalty points
            fetchLoyalty().then(points => {
            // Create a new div element for displaying loyalty points
            const pointsDiv = document.createElement('section');
            const pointsDesc = document.createElement('p');
            pointsDesc.id = 'pointsDesc'
            if (points === null) {
                pointsDesc.innerHTML = `Could not find loyalty points for this account`;
            } else {
                pointsDesc.innerHTML = `Loyalty points balance ${points}`;
            }
            pointsDiv.appendChild(pointsDesc);
            pointsDiv.className = 'cart-section optimizedCheckout-orderSummary-cartSection loyalty-points'; // Add a class name for styling if needed
            // Create a label and input for entering points to use
            const label = document.createElement('label');
            label.setAttribute('for', 'points-input');
            label.classList.add('loyaltyLabel')

            const confirmButton = document.createElement('button')
            confirmButton.textContent = "Apply discount";
            confirmButton.id = "loyaltyPointsBtn";
            confirmButton.className = "btn btn-primary";

            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'points-input';
            input.pattern = '[0-9]';
            input.min = '0';
            input.max = points;
            input.placeholder = 'How many?';
            
            const cancelButton = document.createElement('button')
            cancelButton.textContent = "Cancel discount";
            cancelButton.id = "cancelLoyaltyPointsBtn";
            cancelButton.className = "btn btn-secondary";
            
            cancelButton.addEventListener('click', () => {
                console.log("Received Click");
                const ID = jsContext.checkoutID;
                fetch(`https://purrform-apps-027e.onrender.com/applyDiscountToCheckout?checkoutId=${ID}&loyaltyPointsUsed=0`)
                .then((response) => {
                    cancelButton.setAttribute('disabled', 'true')
                    cancelButton.textContent = 'Removing...'
                    if (!response.ok) {
                        // do something here to let the user know the discount failed
                        cancelButton.removeAttribute('disabled')
                        input.value = ''
                        console.log('Fail')
                    }
                        cancelButton.removeAttribute('disabled')
                        window.location.reload()
                        console.log('Ok')
                })
                .catch(err => {
                    // do something here to let the user know the discount failed
                    cancelButton.removeAttribute('disabled')
                    cancelButton.textContent = 'Remove Discount'
                    input.value = ''
                })
            })
            

            // Add event listener to ensure the input does not exceed the maximum points
            input.addEventListener('input', function () {
                const value = parseInt(this.value, 10);
                if (value > points) {
                    this.value = points;
                }
            });

            // Append the label and input to the usePointsDiv
            pointsDiv.appendChild(label);
            pointsDiv.appendChild(input);
            pointsDiv.appendChild(confirmButton);
            if (document.querySelector('[data-test="cart-discount"]')) {
                pointsDiv.appendChild(cancelButton);
            }
            if (elementToAppend) {
                const duplicates = document.querySelectorAll('.cart-section.optimizedCheckout-orderSummary-cartSection.loyalty-points')
                if (duplicates.length === 0) {
                    elementToAppend.appendChild(pointsDiv);
                    generateNewSummary(points)
                }
            }
            
            const loyaltyPointsBtn = document.querySelector('#loyaltyPointsBtn')
            // Generate a new summary if not done
            // document.querySelector('#applyRedeemableButton').addEventListener('click', () => {
            //     window.location.reload()
            // })
            if (loyaltyPointsBtn) {
                loyaltyPointsBtn.addEventListener('click', () => {
                    console.log("Received Click");
                    if (input.value === '') {
                        return;
                    }
                    const ID = jsContext.checkoutID;
                    const loyaltyPoints = document.querySelector('#points-input').value
                    if (loyaltyPoints === "") {
                        console.log("The input is empty.");
                    }
                    if (loyaltyPoints) {
                        console.log(loyaltyPoints)
                    }
                    fetch(`https://purrform-apps-027e.onrender.com/applyDiscountToCheckout?checkoutId=${ID}&loyaltyPointsUsed=${loyaltyPoints}`)
                    .then((response) => {
                            loyaltyPointsBtn.setAttribute('disabled', 'true')
                            loyaltyPointsBtn.textContent = 'Processing'
                            if (!response.ok) {
                                // do something here to let the user know the discount failed
                                loyaltyPointsBtn.removeAttribute('disabled')
                                input.value = ''
                                console.log('Fail')
                            }
                                loyaltyPointsBtn.removeAttribute('disabled')
                                window.location.reload()
                                console.log('Ok')
                        })
                        .catch(err => {
                            // do something here to let the user know the discount failed
                            loyaltyPointsBtn.removeAttribute('disabled')
                            loyaltyPointsBtn.textContent = 'Apply discount'
                            input.value = ''
                        })
                });
            }
            }).catch(error => {
                console.error('Error fetching loyalty points:', error);
            });
        }
        
        function generateNewSummary(currentUserPoints) {
            currentUserPoints = Number(currentUserPoints);

            const masterContainer = document.createElement('div');
            const masterText = document.createElement('p');
            masterText.classList.add("loyalty-summary")
            masterText.textContent = "Loyalty Points Summary"
            masterContainer.appendChild(masterText)

            const discountEl = document.querySelector('[data-test="cart-discount"] [data-test="cart-price-value"]')
            const earningsEl = document.querySelector('[data-test="cart-subtotal"] [data-test="cart-price-value"]')
            let VAT = document.querySelector('[data-test="cart-taxes"] [data-test="cart-price-value"]')
            let couponDiscount = document.querySelector('[data-test="cart-coupon"] [data-test="cart-price-value"]')
            const existingDiv = document.getElementById('points-input');
            let earningPriceValue
            let earningLoyalPointValue

            let discountPriceValue
            let discountLoyalPointValue

            if (discountEl) {
                // Discount Div
                const discountContainer = document.createElement('div');
                discountContainer.classList.add('cart-summaryItem')

                const discountName = document.createElement('div');
                const discountValue = document.createElement('div');

                discountName.textContent = "Points redeemed"

                discountPriceValue = discountEl.innerHTML.replace(/[^\d.-]/g, '')
                discountPriceValue = discountPriceValue.replace(/[^\d.-]/g, ''); // Remove non-numeric characters
                discountPriceValue = Number(discountPriceValue); 
                discountPriceValue = Math.abs(discountPriceValue);
                discountLoyalPointValue = discountPriceValue * 100
                discountLoyalPointValue = Math.floor(discountLoyalPointValue);
                
                discountValue.textContent = `-${discountLoyalPointValue}`

                discountContainer.appendChild(discountName)
                discountContainer.appendChild(discountValue)
                masterContainer.appendChild(discountContainer)
            }
            if (earningsEl) {
                // Earning Div
                const earningContainer = document.createElement('div');
                earningContainer.classList.add('cart-summaryItem')

                const earningName = document.createElement('div');
                const earningValue = document.createElement('div');

                earningName.textContent = "Points earned"
                earningPriceValue = earningsEl.innerHTML
                earningPriceValue = earningPriceValue.replace(/[^\d.-]/g, ''); // Remove non-numeric characters
                earningPriceValue = Number(earningPriceValue); // Use parseFloat to handle decimal values
                if (discountEl) {
                    earningPriceValue = earningPriceValue - discountPriceValue
                }
                /*
                if (VAT) {
                    VAT = Math.round(Number(VAT.innerHTML.replace(/[^\d.-]/g, '')));
                    earningPriceValue -= VAT;
                }
                */
                if (couponDiscount) {
                    earningPriceValue -= Math.floor(Math.abs(Number(couponDiscount.innerHTML.replace(/[^\d.-]/g, ''))));
                }
                
                earningLoyalPointValue = earningPriceValue / 2;

                earningLoyalPointValue = Math.floor(earningLoyalPointValue);
                if (earningLoyalPointValue < 0) {
                    earningValue.textContent = `+0`
                } else {
                    earningValue.textContent = `+${earningLoyalPointValue}`
                }

                earningContainer.appendChild(earningName)
                earningContainer.appendChild(earningValue)
                masterContainer.appendChild(earningContainer)
            }
            const finalContainer = document.createElement('div');
            const finalResult = document.createElement('div');
            const finalResultText = document.createElement('p');

            const finalType = document.createElement('div');
            const finalTypeText = document.createElement('p');
            finalTypeText.textContent = 'Estimated total after purchase:'
            if (earningsEl && discountEl && currentUserPoints) {
                finalResultText.textContent  = `${(currentUserPoints + earningLoyalPointValue  - discountLoyalPointValue)}`
            } else if (earningsEl && currentUserPoints){
                finalResultText.textContent  = `${currentUserPoints + earningLoyalPointValue}`
            } else {
                finalResultText.textContent  = `${earningLoyalPointValue}`
            }
            finalType.appendChild(finalTypeText)
            finalResult.appendChild(finalResultText)
            finalContainer.appendChild(finalType)
            finalContainer.appendChild(finalResult)
            finalContainer.classList.add('cart-resultItem')

            masterContainer.appendChild(finalContainer)
            existingDiv.insertAdjacentElement('afterend', masterContainer);
        }

        // Append the usePointsDiv to the target element
        function fetchLoyalty() {
            return fetch('/graphql', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer {{ settings.storefront_api.token }}'
                },
                body: JSON.stringify({
                    query: `
                        query loyaltyQuery{
                            customer {
                                attributes {
                                    attribute(entityId: 1) {
                                        value
                                        name
                                    }
                                }
                            }
                        }
                    `
                }),
            })
            .then(res => res.json())
            .then(json => {
                const attribute = json.data.customer.attributes.attribute;
                const points = attribute ? attribute.value : '0'; // Default to '0' if attribute is not found
                return points;
            })
            .catch(error => {
                console.error('Error fetching loyalty points:', error);
                return '0'; // Return '0' in case of error
            });
        }
    </script>
    {{/unless}}
{{/if}}



<script>
    // This script handles 'datepicker' in 'shipping'
    let shippingInterval = setInterval(shippingChecker, 1000);
    function shippingChecker() {
        const element = document.querySelector('#checkout-shipping-options');
        const shippingMethod = document.querySelector('.form-checklist');
        if (element && element !== null && shippingMethod) {
            clearInterval(shippingInterval); // Stop the interval once the element is found
            createCalendar(element)
        }
    }
    function createCalendar(element) {
        const existingInstructions = document.getElementById('datepicker-hoster');
        if (existingInstructions) {
            existingInstructions.remove();
        }
        // Define the HTML code for the elements
        const datePickerHTML = `
            <div id="datepicker-hoster" class="datepicker">
                <div class="cart-total-label">
                    <strong style="color: #687d6a;">Delivery Date *</strong>
                </div>
                <div class="voucher-section">
                    <input type="text" id="datepicker" name="datepicker" readonly autocomplete="off" aria-autocomplete="none" class="form-input" style="background: white; width: calc(100%); border-radius: 45px; border-color: #687d6a; color: #687d6a; font-size: 16px; text-align: center;" onkeydown="return false;">
                    <p id="datepicker_err" style="display: none; color: #363636; font-size: 16px; font-weight: normal;"></p>
                </div>
                <p style="font-size: 16px;">*Next Day delivery is usually available on any orders placed before 12 noon, Monday to Friday. Excluding some postcodes in Scotland.</p>
            </div>
        `;
        element.insertAdjacentHTML('beforeend', datePickerHTML);
        getCalendarData();
    }
    // Get data for the calendar
    function getCalendarData() {
        // Create calendar and attach date picker logic here
        let dailyDeliveryLimit = 250;
        const dailySlotValues = {};
        const disabledDates = [];
        // get delivery dates from middleware
        fetch('https://purrform-apps-027e.onrender.com/deliveryDates')
            .then((response) => {
                if (!response.ok) {
                    console.log('Middleware network response was not ok');
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then((data) => {
                disabledDates.push(...data.unavailableDates);
                for (const [date, slots] of Object.entries(data.dateSlots)) {
                    dailySlotValues[date] = slots;
                }
                if (data.perDay) {
                    dailyDeliveryLimit = data.perDay;
                }
                attachDatePicker(dailyDeliveryLimit, dailySlotValues, disabledDates);
            })
            .catch((error) => {
                console.log('Error calling delivery dates middleware endpoint:', error);
                // Handle error if necessary
            });
    }
    // Attach
    function attachDatePicker(dailyDeliveryLimit, dailySlotValues, holidays) {
  

        function disableDates(date) {
            let result = [true, '', '']; // Default result to ensure proper return format
            const ulElement = document.querySelector('.form-checklist');
            if (ulElement) {
                const liElements = ulElement.querySelectorAll('li');
                liElements.forEach(li => {
                    const listItem = li.querySelector('.shippingOption-desc');
                    const listItemText = listItem.innerHTML;
                    const isSaturday = listItemText.toLowerCase().includes('saturday');
                    // The initial
                    if (li.classList.contains('form-checklist-item--selected')) {
                        if (isSaturday) {
                            result = enableSaturday(date);
                        } else {
                            result = enableWeekdays(date);
                        }
                    }
                    // Clicker
                    li.addEventListener('click', function() {
                        // Check if the clicked LI does not have the 'form-checklist-item--selected' class
                        if (!li.classList.contains('form-checklist-item--selected')) {
                            // Print a message to the console based on the LI's inner HTML
                            if (isSaturday) {
                                result = enableSaturday(date);
                            } else {
                                result = enableWeekdays(date);
                            }
                        }
                    });
                });
            } else {
                result = enableWeekdays(date);
            }
            return result;
        }
        // Disable everything except Saturday
        function enableSaturday(date) {
            const dayBeingChecked = $.datepicker.formatDate('yy-mm-dd', date);
            const dayOfTheWeek = date.getDay();
            const dayOfMonth = date.getDate();
            let slotsForThisDay = dailySlotValues[dayBeingChecked] ?? dailyDeliveryLimit;
            if (slotsForThisDay > dailyDeliveryLimit) {
                slotsForThisDay = dailyDeliveryLimit;
            }
            // Enable 6th day of the week (Saturday) AND if slots is higher than 0
            let isSaturdayWithSlots
            isSaturdayWithSlots = (dayOfTheWeek === 6 && slotsForThisDay > 0 && slotsForThisDay > 0 && !holidays.includes(dayBeingChecked) );
            if (sessionStorage.getItem('deliveryDate')) {
                sessionStorage.clear('deliveryDate')
                location.reload();
            }
            $('#datepicker').val('');
            return [isSaturdayWithSlots, '', `Slots available: ${slotsForThisDay}`];
        }
        // Enable weekdays
        function enableWeekdays(date) {
            const dayBeingChecked = $.datepicker.formatDate('yy-mm-dd', date);
            const dayOfTheWeek = date.getDay();
            let slotsForThisDay = dailySlotValues[dayBeingChecked] ?? dailyDeliveryLimit;
            if (slotsForThisDay > dailyDeliveryLimit) {
                slotsForThisDay = dailyDeliveryLimit;
            }
            // Enable if not 6 (Saturday) 0 (Sunday) AND 1 (Monday) 
            let isEnabledDay
            isEnabledDay = (dayOfTheWeek !== 6 && dayOfTheWeek !== 0 && dayOfTheWeek !== 1 && slotsForThisDay > 0  && !holidays.includes(dayBeingChecked) );
            if (sessionStorage.getItem('deliveryDate')) {
                sessionStorage.clear('deliveryDate')
                location.reload();
            }
            $('#datepicker').val('');
            return [isEnabledDay, '', `Slots available: ${slotsForThisDay}`];
        }
        // Check if the session token for delivery date has been generated
        if (sessionStorage.getItem('deliveryDate')) {
            const datepicker = document.querySelector('#datepicker');
            const deliveryDate = sessionStorage.getItem('deliveryDate');
            datepicker.value = deliveryDate;
        }
        
        $('#datepicker').datepicker({
            beforeShowDay: disableDates,
            defaultDate: '+1D',
            minDate: '+1D',
            maxDate: '+21D',
            dateFormat: 'd MM, yy',
            showOtherMonths: true,
            firstDay: 1,
            placeholder: 'Select Date'
        });
        $('#datepicker').attr('placeholder', 'Select Date');
    }
</script>


<script>
    // This script handles 'instructions' in 'shipping'
    let instructionInterval = setInterval(instructionCheck, 1000);
    function instructionCheck() {
        const element = document.querySelector('fieldset.form-fieldset[data-test="checkout-shipping-comments"]');
        const shippingMethod = document.querySelector('.form-checklist');
        if (element && shippingMethod) {
            clearInterval(instructionInterval);
            createInstructions(); 
        }
    }
    function createInstructions() {
        const existingInstructions = document.getElementById('instruction-wrap');
        if (existingInstructions) {
            existingInstructions.remove();
        }
        // generate custom HTML
        const instructionsDiv = `
        <div id="instruction-wrap" class="delivery_instruction_wrapper">
            <div class="del_cont">
                <label class="form-legend optimizedCheckout-headingSecondary">Delivery Details</label>
                <select class="form-select form-select--small" id="delivery_inst_tag" onchange="showTextarea()">
                    <option value="Will be in">Will be in</option>
                    <option value="user_instruction">User instruction</option>
                </select>
                <div id="word_limit" style="text-align: right;padding: 3px 0;display:none">(30 characters)</div>
                <textarea style="display:none" name="delivery_user_text" id="delivery_user_text" rows="1" cols="40" class="form-input"></textarea>
            </div>
            <p id="warningMessage" class="warning" style="display:none;">Please fill the required field.</p>
            <div id="proceedButton">Continue</div>
        </div>
        `;
        // Select the div with class 'checkout-address'
        const instructionSpot = document.querySelector('fieldset.form-fieldset[data-test="checkout-shipping-comments"]');
        // Append the HTML code to the 'checkout-instruction' div
        instructionSpot.insertAdjacentHTML('afterend', instructionsDiv);
    }
    function showTextarea() {
        const selectElement = document.getElementById('delivery_inst_tag');
        const textarea = document.getElementById('delivery_user_text');
        if (selectElement.value === 'user_instruction') {
            textarea.style.display = 'block';
        } else {
            textarea.style.display = 'none';
        }
    }
</script>

<script>
    // This script handles 'Shipping' continue button
    let resetInterval = setInterval(resetCheck, 1000);
    function resetCheck() {
        // Button by BC
        const shipButton = document.querySelector('#checkout-shipping-continue');
        // Mockup button
        const proceedButton = document.querySelector('#proceedButton')
        const shippingMethod = document.querySelector('.form-checklist');
        if (shipButton && proceedButton && shippingMethod) {
            // Stop the interval once the shipButton is found
            clearInterval(resetInterval); 
            // Execute the function
            resetFunction(shipButton, proceedButton); 
        }
    }
    function resetFunction(shipButton, proceedButton) {
        // Add event for new button
        proceedButton.addEventListener('click', function() {
            let finalInstructions = "";
            // Get session keys if they exist
            const deliveryDate = sessionStorage.getItem('deliveryDate');
            const deliveryInstr = sessionStorage.getItem('tracked_input_text');
            // Get datepicker
            const datepicker = document.querySelector('.datepicker')
            const datePickerValue = document.querySelector('#datepicker').value
            // Get instructions
            const instructionSelector = document.querySelector('#delivery_inst_tag');
            const inputElement = document.querySelector('input[name="orderComment"]');
            // Set URL
            const url ="/api/storefront/checkouts/{{cart_id}}";
            // Get warning
            const warning = document.querySelector("#warningMessage");
            // Check if user decided to add instructions
            if (instructionSelector.value === "user_instruction") {
                const textarea = document.querySelector('#delivery_user_text');
                // If no instructions provided
                if (textarea.value.length == 0) {
                    textarea.value = "Will be in";
                }
                finalInstructions = textarea.value;
            } else {
                finalInstructions = instructionSelector.value;
            }
            // Fill instructions and data
            const fullInstructions = `${datePickerValue} | ${finalInstructions}`;
            const newData = {customerMessage: fullInstructions};
            //// Set and Put
            // Set input
            inputElement.value = fullInstructions;
            // Put request
            if (!datePickerValue == '' && !shipButton.disabled) {
                fetch("/api/storefront/checkouts/{{cart_id}}", {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newData)
                })
                .then(response => {
                        if (!response.ok) {
                            throw new Error('PUT request failed');
                        }
                        return response.json(); // Parse the JSON response
                })
                .then(data => {
                        console.log('PUT request successful');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                });
                // If delivery date is different
                if (deliveryDate) {
                    if (deliveryDate !== datePickerValue) {
                        // console.log('Date did not match')
                        location.reload();
                    }
                } 
                // If delivery instructions are different
                if (deliveryInstr) {
                    if (finalInstructions !== deliveryInstr) {
                        // console.log('Instructions did not match')
                        location.reload();
                    }
                }
                // Assign new storage
                sessionStorage.setItem('tracked_input_text', finalInstructions);
                sessionStorage.setItem('deliveryDate', datePickerValue);
                // Remove warnings
                warning.style.display = "none"
                datepicker.classList.remove('warning')
                // Add delay to ensure put is ran
                setTimeout(function () {
                    shipButton.click();
                }, 1000);
                setTimeout(function () {
                    resetInterval = setInterval(resetCheck, 1000);
                    instructionInterval = setInterval(instructionCheck, 1000);
                    shippingInterval = setInterval(shippingChecker, 1000);
                }, 2000); 
            //User used shipping method but failed to fill in datepicker
            } else if (datePickerValue == '' && !shipButton.disabled) {
                warning.style.display = "block"
                warning.textContent = "Please fill in the datepicker field.";
                datepicker.classList.add('warning')
            // User used darepicker but failed to fill shipping method
            } else if (!datePickerValue == '' && shipButton.disabled) {
                warning.style.display = "block"
                warning.textContent = "Please select a shipping method.";
            } 
        });
    }
</script>

<script>
    // This script handles Payment Behaviour
    let finalInterval = setInterval(finalCheck, 1000);
    function finalCheck() {
        const element = document.querySelector('#checkout-payment-continue')
        if (element && element.innerHTML !== null) {
            // Generate elements and append location
            const fakeButton = document.createElement("div");
            const missingWarn = document.createElement("p")
            const location = document.querySelector(".checkout-step--payment .checkout-form .form-actions")
            // Generate placeholder button
            fakeButton.innerHTML = "Place Order";
            fakeButton.id = 'fakeButton';
            fakeButton.style.display = 'none';
            // Generate warning text
            missingWarn.classList.add('warning');
            missingWarn.textContent = "Cannot find delivery date. Please review your 'shipping' details.";
            missingWarn.style.display = "none";
            // Append the button to the body of the HTML document
            if (!document.querySelector('#fakeButton')) {
                location.appendChild(missingWarn);
                location.appendChild(fakeButton);
                finalFunction(element, fakeButton, missingWarn);
            }
        }
    }
    function finalFunction(element, fakeButton, missingWarn) {
        // Make sure its targetting the right 'order' button
        let mimicInterval = setInterval(function () {
            const nearestTar = document.querySelector('#checkout-payment-continue')
            if (nearestTar) {
                // Clear interval
                clearInterval(mimicInterval);
                // Hide real, show fake just incase
                element.style.display = 'none'
                fakeButton.style.display = 'block'
                // Add event now that it has the correct target
                fakeButton.addEventListener('click', () => {
                    fetch("/api/storefront/checkouts/{{cart_id}}", {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                    .then(response => {
                            if (!response.ok) {
                                throw new Error('PUT request failed');
                            }
                            return response.json(); // Parse the JSON response
                    })
                    .then(data => {
                            const deliveryInstructions = data.customerMessage
                            if (data.customerMessage && data.customerMessage.trim()) {
                                nearestTar.click();
                            } else {
                                missingWarn.style.display = "block";
                            }
                        })
                    .catch(error => {
                            console.error('Error:', error);
                    });
                })
            }
        }, 1000);

        // Add reset button incase user changes their mind
        const editButtons = document.querySelectorAll('.checkout-step .button--tertiary.button--tiny.optimizedCheckout-buttonSecondary')
        editButtons.forEach(editButton => {
            editButton.addEventListener('click', () => {
                // reset the interval
                finalInterval = setInterval(finalCheck, 1000);
            })
        });
    }

</script>

<style>
    .loyalty-summary {
        margin: 10px 0;
    }
    .cart-resultItem {
        display: grid;
        grid-template-columns: 1fr auto;
        margin-top: 0.5rem;
        padding-bottom: 0.2rem;
    }
    .cart-resultItem p {
        font-weight: bold;
    }
    .cart-summaryItem {
        display: grid;
        grid-template-columns: 1fr auto;
        border-bottom: 1px solid #333333;
        margin-top: 0.5rem;
        padding-bottom: 0.2rem;
    }
    #pointsDesc {
        font-weight: bold;
        margin-bottom: 20px;
    }
    #usedPointsDesc {
        margin: 0;
    }
    .btn.btn-primary,
    .btn.btn-secondary {
        border: 1px solid #687d6a;
        border-radius: 32px;
        font-size: 16px;
        background-color: #687d6a;
        -webkit-transition: all 0.15s ease;
        transition: all 0.15s ease;
        padding: 16px 13px;
        color: white;
        text-transform: uppercase;
        margin-top: 20px;
    }
    .btn.btn-primary:hover,
    .btn.btn-secondary:hover {
        background-color: white;
        color: #687d6a;
    }
    .modal.modal--afterOpen.optimizedCheckout-cart-modal .modal-body {
        box-shadow: none;
        height: 100%; 
        padding-bottom: 0;
        overflow-x: auto;
        overflow-y: auto; 
    }
    .loyalty-points {
        display: flex;
        flex-direction: column;
        background-color: #FFEDCD;
    }
    @media (max-width: 600px) {
        .loyalty-points {
            background-color: transparent; 
        }
    }
    #points-input {
        border: 1px solid #dbdada;
        border-radius: 32px;
        padding: 16px 12px;
    }
    fieldset[data-test="checkout-shipping-comments"],
    #checkout-shipping-continue,
    input[name="orderComment"],
    #checkout-payment-continue {
        display: none;
    }
    .warning {
        color: red !important;
        border-color: red !important;
    }

    .warning * {
        color: red !important;
        border-color: red !important;
    }

    #fakeButton,
    #proceedButton {
        color: white;
        border: 1px solid #687d6a;
        border-radius: 32px;
        font-size: 16px;
        background-color: #687d6a;
        transition: all 0.15s ease;
        font-family: "Montserrat", Arial, Helvetica, sans-serif;
        font-weight: 500;
        padding: 14px 24px;
        text-align: center;
        width: 100%;
        margin: 20px 0px;
        cursor: pointer;
        vertical-align: baseline;
        display: inline-block;
        text-transform: uppercase;
        font-weight: bold;
    }

    #fakeButton:hover,
    #proceedButton:hover {
        background-color: transparent;
        color: #687d6a;
    }

    /* DATE PICKER */
    .datepicker {
        z-index: 1;
    }

    .datepicker .voucher-section .warning #datepicker {
        border-color: red;
    }

    .ui-datepicker,
    .ui-datepicker table,
    .ui-datepicker tr,
    .ui-datepicker td,
    .ui-datepicker th {
        margin: 0;
        padding: 0;
        border: none;
        border-spacing: 0;
    }

    .ui-datepicker {
        box-shadow: 0 5px 12px rgb(0 0 0 / 15%);
        display: none;
        width: 100%;
        padding: 15px;
        cursor: default;
        text-transform: uppercase;
        font-family: Filson-Soft;
        font-size: 24px;
        background: #fff;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
        border: solid 1px #bd9b60;
    }

    .ui-datepicker .ui-datepicker-header {
        position: relative;
        border: 1px solid #bd9b60;
        background: #bd9b60 !important;
        font-size: 1.2rem;
    }

    .ui-datepicker-title {
        text-align: center;
        font-family: Filson-Soft;
    }

    .ui-datepicker-month {
        position: relative;
        padding-right: 15px;
        color: #fff;
        font-family: Filson-Soft;
    }

    /* .ui-datepicker-current-day .ui-state-default {background-color:#687d6a;color: #bd9b60;} */
    .ui-datepicker-year {
        padding-left: 8px;
        color: #fff;
        font-family: Filson-Soft;
    }

    .ui-datepicker-month:before {
        display: block;
        position: absolute;
        top: 5px;
        right: 0;
        width: 5px;
        height: 5px;
        content: '';
        background: #bd9b60;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
    }

    .ui-datepicker-prev,
    .ui-datepicker-next {
        position: absolute;
        top: 4px !important;
        padding: 5px;
        cursor: pointer;
    }

    .ui-datepicker-prev {
        left: 0;
        padding-left: 0;
    }

    .ui-datepicker-next {
        right: 0;
        padding-right: 0;
    }

    .ui-state-hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .ui-datepicker-calendar th {
        padding-top: 15px;
        padding-bottom: 10px;
        text-align: center;
        font-weight: normal;
        color: #a8a8a8;
        font-size: 1rem;
    }

    .ui-datepicker-calendar td {
        padding: 2px 2px;
        text-align: center;
        line-height: 26px;
    }

    .ui-datepicker-calendar .ui-state-default {
        display: block;
        width: 100%;
        -webkit-border-radius: 50px;
        -moz-border-radius: 50px;
        border-radius: 50px;
        outline: none;
        text-decoration: none;
        color: #000;
        border: 1px solid transparent;
    }

    .ui-datepicker-calendar .ui-state-active {
        border-color: #bd9b60 !important;
        background-color: #bd9b60 !important;
    }

    .ui-datepicker-other-month .ui-state-default {
        color: #ccc;
    }

    .ui-datepicker-other-month {
        opacity: 0 !important;
    }

    .ui-datepicker table {
        margin: 0 auto;
    }

    .ui-datepicker-week-end .ui-state-default {
        background-color: #bd9b60 !important;
        border: 1px solid #bd9b60 !important;
    }

    .ui-widget.ui-widget-content {
        border: 1px solid #fff !important;
        max-width: 340px;
        -webkit-border-radius: 20px;
        -moz-border-radius: 20px;
        border-radius: 20px;
    }

    .ui-state-default,
    .ui-widget-content .ui-state-default,
    .ui-widget-header .ui-state-default,
    .ui-button,
    html .ui-button.ui-state-disabled:hover,
    html .ui-button.ui-state-disabled:active {
        text-align: center;
    }
</style>

{{/partial}}

{{> layout/empty}}
